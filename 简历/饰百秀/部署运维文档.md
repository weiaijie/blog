# Special 项目部署运维文档

## 环境要求

### 系统要求
- **操作系统**: Linux (推荐 Ubuntu 18.04+) / Windows 10+ / macOS 10.15+
- **Node.js**: 14.x 或更高版本
- **npm/pnpm**: npm 6.x+ 或 pnpm 6.x+
- **MySQL**: 5.7+ 或 8.0+
- **Redis**: 5.0+

### 硬件要求
- **CPU**: 2核心以上
- **内存**: 4GB以上
- **存储**: 20GB以上可用空间
- **网络**: 稳定的网络连接

## 项目结构

```
special/
├── special-admin-web/    # 管理后台前端
├── special-app/          # 移动端应用
├── special-node/         # Node.js中间层
├── special-server/       # 简单服务器
└── docs/                 # 文档目录
```

## 开发环境部署

### 1. 环境准备

#### 安装Node.js
```bash
# 使用nvm安装Node.js (推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 16
nvm use 16

# 或直接下载安装
# https://nodejs.org/
```

#### 安装包管理器
```bash
# 安装pnpm (推荐)
npm install -g pnpm

# 或使用npm
npm install -g npm@latest
```

### 2. 数据库配置

#### MySQL配置
```sql
-- 创建数据库
CREATE DATABASE special_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'special_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON special_db.* TO 'special_user'@'%';
FLUSH PRIVILEGES;
```

#### Redis配置
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install redis-server

# CentOS/RHEL
sudo yum install redis

# 启动Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 3. 项目部署

#### 3.1 移动端应用 (special-app)
```bash
cd special-app

# 安装依赖
npm install

# 开发环境启动
npm run dev

# 构建生产版本
npm run build

# 构建开发版本
npm run build_dev
```

#### 3.2 管理后台 (special-admin-web)
```bash
cd special-admin-web

# 安装依赖
pnpm install

# 开发环境启动
pnpm run serve

# 构建生产版本
pnpm run build
```

#### 3.3 Node.js中间层 (special-node)
```bash
cd special-node

# 安装依赖
npm install

# 开发环境启动
npm run start

# 生产环境启动
npm run build

# Windows环境
npm run startwin
npm run buildWin
```

#### 3.4 简单服务器 (special-server)
```bash
cd special-server

# 安装依赖
npm install

# 启动服务器
node app.js
```

### 4. 配置文件修改

#### 4.1 Node.js配置 (special-node/config/config.js)
```javascript
// 修改数据库配置
let config = {
  updbQuery: {
    host: 'your_mysql_host',
    user: 'special_user',
    password: 'your_password',
    database: 'special_db',
    port: 3306,
    connectionLimit: 100
  },
  
  // 修改Redis配置
  sessionStore: {
    host: 'your_redis_host',
    port: 6379,
    db: 9,
    ttl: 60 * 60 * 12
  },
  
  // 修改跨域配置
  headerOrigin: [
    'http://localhost:8080',
    'http://your_domain.com'
  ]
}
```

#### 4.2 前端API配置
```javascript
// special-app/src/utils/request.ts
const baseURL = process.env.NODE_ENV === 'production' 
  ? 'http://your_api_domain.com' 
  : 'http://localhost:8669'
```

## 生产环境部署

### 1. 服务器准备

#### 系统配置
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y nginx mysql-server redis-server git curl

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2
sudo npm install -g pm2
```

### 2. 数据库部署

#### MySQL生产配置
```bash
# 安全配置
sudo mysql_secure_installation

# 配置文件优化 /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
query_cache_size = 64M
```

#### Redis生产配置
```bash
# 配置文件 /etc/redis/redis.conf
bind 127.0.0.1
port 6379
timeout 300
maxmemory 512mb
maxmemory-policy allkeys-lru
```

### 3. 应用部署

#### 3.1 前端部署
```bash
# 构建前端应用
cd special-app
npm run build

cd ../special-admin-web
pnpm run build

# 配置Nginx
sudo vim /etc/nginx/sites-available/special
```

#### Nginx配置示例
```nginx
server {
    listen 80;
    server_name your_domain.com;
    
    # 移动端应用
    location / {
        root /var/www/special-app/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 管理后台
    location /admin {
        alias /var/www/special-admin-web/dist;
        try_files $uri $uri/ /admin/index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://localhost:8669;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 3.2 后端部署
```bash
# 部署Node.js应用
cd special-node

# 安装生产依赖
npm install --production

# 使用PM2启动
pm2 start ecosystem.config.js
```

#### PM2配置文件 (ecosystem.config.js)
```javascript
module.exports = {
  apps: [{
    name: 'special-node',
    script: './bin/www',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development',
      PORT: 8669
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 8669
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
}
```

### 4. SSL证书配置

#### 使用Let's Encrypt
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your_domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 监控与日志

### 1. 应用监控

#### PM2监控
```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs

# 监控面板
pm2 monit

# 重启应用
pm2 restart special-node
```

#### 系统监控
```bash
# 安装监控工具
sudo apt install htop iotop nethogs

# 查看系统资源
htop
iotop
nethogs
```

### 2. 日志管理

#### 应用日志
```bash
# Node.js应用日志
tail -f special-node/logs/combined.log

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

#### 日志轮转配置
```bash
# 创建logrotate配置
sudo vim /etc/logrotate.d/special

# 配置内容
/var/www/special-node/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        pm2 reload special-node
    endscript
}
```

## 备份策略

### 1. 数据库备份
```bash
#!/bin/bash
# backup_mysql.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="special_db"

mkdir -p $BACKUP_DIR

mysqldump -u special_user -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/special_db_$DATE.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
```

### 2. 文件备份
```bash
#!/bin/bash
# backup_files.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/files"
APP_DIR="/var/www"

mkdir -p $BACKUP_DIR

tar -czf $BACKUP_DIR/special_files_$DATE.tar.gz $APP_DIR

# 保留最近7天的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

### 3. 自动备份
```bash
# 添加到crontab
sudo crontab -e

# 每天凌晨2点备份数据库
0 2 * * * /path/to/backup_mysql.sh

# 每周日凌晨3点备份文件
0 3 * * 0 /path/to/backup_files.sh
```

## 性能优化

### 1. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_project_name ON projects(project_name);
CREATE INDEX idx_customer_mobile ON customers(mobile);
CREATE INDEX idx_task_status ON tasks(status);

-- 查询优化
EXPLAIN SELECT * FROM projects WHERE project_name LIKE '%keyword%';
```

### 2. Redis优化
```bash
# Redis配置优化
maxmemory 1gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### 3. Nginx优化
```nginx
# 启用Gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript;

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## 故障排查

### 常见问题

#### 1. 应用无法启动
```bash
# 检查端口占用
netstat -tulpn | grep :8669

# 检查日志
pm2 logs special-node

# 检查配置文件
node -c special-node/app.js
```

#### 2. 数据库连接失败
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 测试连接
mysql -u special_user -p -h localhost special_db

# 检查防火墙
sudo ufw status
```

#### 3. Redis连接失败
```bash
# 检查Redis状态
sudo systemctl status redis

# 测试连接
redis-cli ping

# 检查配置
sudo vim /etc/redis/redis.conf
```

### 性能问题排查
```bash
# 查看系统负载
uptime
top

# 查看内存使用
free -h

# 查看磁盘使用
df -h

# 查看网络连接
ss -tulpn
```

## 安全加固

### 1. 系统安全
```bash
# 更新系统
sudo apt update && sudo apt upgrade

# 配置防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443

# 禁用root登录
sudo vim /etc/ssh/sshd_config
# PermitRootLogin no
```

### 2. 应用安全
```bash
# 设置文件权限
sudo chown -R www-data:www-data /var/www
sudo chmod -R 755 /var/www

# 隐藏Nginx版本
sudo vim /etc/nginx/nginx.conf
# server_tokens off;
```

### 3. 数据库安全
```sql
-- 删除测试数据库
DROP DATABASE IF EXISTS test;

-- 删除匿名用户
DELETE FROM mysql.user WHERE User='';

-- 刷新权限
FLUSH PRIVILEGES;
```

这个部署运维文档涵盖了从开发环境到生产环境的完整部署流程，包括监控、备份、性能优化和故障排查等运维要点。
