# Special 项目详细业务逻辑实现分析

## 1. 任务状态流转机制

### 1.1 任务状态定义
```javascript
const status = {
  "0": "进行中",     // 任务已分配，正在执行
  "1": "待审核",     // 任务已提交，等待审核
  "2": "已完成",     // 任务审核通过，已完成
  "3": "已延期",     // 任务超过截止时间未完成
}
```

### 1.2 任务级别定义
```javascript
const taskLevel = {
  1: "审批人级别",   // approver_id - 具有审批权限
  2: "负责人级别",   // responsible_id - 项目负责人
  3: "执行人级别",   // executor_id - 具体执行人员
}
```

### 1.3 状态流转逻辑

#### 任务开始流程
```javascript
// 判断是否可以开始任务
const isToDay = (record) => {
  let name = {
    '3': 'executor_id',    // 执行人
    '2': 'responsible_id', // 负责人  
    '1': 'approver_id',    // 审批人
  }
  // 条件：未开始 && 当前用户是对应角色 && 当前日期是开始日期
  if(record.is_start == 0 && state.uid == record[name[record.level]]){
    return dateToString(new Date(),'getDate') == record.start_time ? true : false
  }
  return false
}

// 开始任务
const submitStartTask = (id, index) => {
  startTask({id: id}).then((res) => {
    if(res.data.code == 1){
      tableData.value[index].is_start = 1  // 更新任务状态为已开始
      Toast('操作成功')
    }
  })
}
```

#### 任务提交流程
```javascript
// 任务提交验证逻辑
const onSubmit = () => {
  // 1. 验证任务内容必须选中
  if(!formState.status){
    Toast("必须选中任务内容!")
    return false
  }
  
  // 2. 验证所有子任务必须完成
  for(let i in curContent.value){
    if(curContent.value[i].is_checked != true){
      Toast("有未提交的下级任务!")
      return false
    }
  }
  
  // 3. 验证必须上传附件
  if(fileList.value.length == 0) {
    Toast("必须上传附件!")
    return false
  }
  
  // 4. 根据任务类型调用对应的提交接口
  let post = dynamicinterface[state.data.type.toString()][1]
  post(params).then((res) => {
    if (res.data.code == 1) {
      Toast("提交成功!")
      // 任务状态变更为"待审核"
    }
  })
}
```

#### 任务审核流程
```javascript
// 任务点击处理逻辑
const rowClick = (record, index) => {
  // 1. 如果是今天开始的任务，直接开始
  if(isToDay(record)){
    submitStartTask(record.id, index)
    return 
  }
  
  // 2. 特殊任务需要在PC端操作
  if(record.is_first == 1 || record.place_order == 1) {
    goPcOpen()  // 显示PC操作提示
    return
  }
  
  // 3. 根据用户角色和任务状态进行路由跳转
  if(record.level == 1){
    // 审批人且任务进行中 -> 进入表单页面
    if(record.approver_id == state.uid && record.state == 0){
      router.push({path: `/project-detail/form`, query: item})
    }
    // 成员且任务待审核 -> 进入审核页面  
    else if(record.member_id == state.uid && record.state == 1){
      router.push({path: `/project-detail/audit-task`, query: record})
    }
    // 任务已完成 -> 查看详情
    else if(record.state == 2){
      router.push({path: `/project-detail/form`, query: item})
    }
    else{
      Toast('暂时无法操作!')
    }
  }
}
```

### 1.4 延期任务处理逻辑

#### 延期任务识别
```javascript
// 获取任务列表时的参数处理
const getParams = () => {
  let params = `?project_id=${state.data.project_id}&page=${state.pagination.page}&limit=${state.pagination.limit}`
  
  if(state.curMenuTag == '0'){
    params += `&state=0`        // 进行中任务
  }else if(state.curMenuTag == '1'){
    params += `&is_delay=1`     // 延期任务
  }
  return params
}

// 延期任务统计显示
<van-tab :title="`已延期任务(${delayNum})`" name="1"></van-tab>
```

#### 延期任务标记
- 后端通过比较任务的 `end_time` 和当前时间自动标记延期
- 前端通过 `is_delay=1` 参数获取延期任务列表
- 延期任务数量通过 `delay_num` 字段显示

## 2. 用户权限和角色管理逻辑

### 2.1 用户认证流程

#### 飞书登录集成
```javascript
// 权限控制入口 - permission.ts
router.beforeEach((to, from, next) => {
  let url = `https://open.feishu.cn/open-apis/authen/v1/index?redirect_uri=${escape(process.env.VUE_APP_LINK_URL)}&app_id=${escape(process.env.VUE_APP_ID)}&state=1`
  
  // 检查Token和用户ID
  if (getToken() && getTokenUserId()) { 
    // 刷新页面时重新获取用户信息
    if((store.state.user.token == '' || store.state.user.token == undefined) && getToken()){ 
      store.dispatch('GetUserInfo').then(() => {
        next()
      });
    }else{
      // 验证Token是否过期
      store.dispatch('GetCheckToken').then(res => {
        if(!res){
          next()
        }else{
          console.log('token过期')
          // Token过期，重新登录
        }
      });
    }
  }else {
    // 没有Token，执行登录流程
    Login()
  }
})
```

#### 登录状态管理
```javascript
// Vuex用户状态管理
const user = {
  state: {
    uid: '',      // 用户ID
    token: '',    // 访问令牌
    name: '',     // 用户姓名
    avatar: '',   // 用户头像
    roles: [],    // 用户角色
  },
  
  actions: {
    // 登录处理
    Login({ commit, state }, userInfo) {
      return new Promise((resolve, reject) => {
        login({ code: userInfo }).then((response) => {
          if (response.status == 200) {
            let data = response.data
            if (data.code == 1) {
              // 保存用户信息到状态和本地存储
              commit('SET_UID', data.data.user_id)
              commit('SET_TOKEN', data.data.access_token)
              commit('SET_NAME', data.data.nickname)
              commit('SET_AVATAR', data.data.avatar)
              
              setToken(data.data.access_token)
              setTokenName(data.data.nickname)
              setTokenAvatar(data.data.avatar)
              setTokenUserId(data.data.user_id)
              
              Toast('登录成功!')
              resolve(response)
            }
          }
        })
      })
    }
  }
}
```

### 2.2 角色权限控制

#### 项目成员角色管理
```javascript
// 获取项目成员
getProjectMember(`?project_id=${project_id}`)

// 添加项目成员
insertMember({
  project_id: 1,
  user_id: 2,
  role_id: 3    // 角色ID决定权限级别
})

// 删除项目成员
deleteMember({
  project_id: 1,
  user_id: 2
})
```

#### 任务操作权限控制
```javascript
// 基于用户ID和角色的权限判断
const hasPermission = (record, action) => {
  const currentUserId = store.state.user.uid
  
  switch(action) {
    case 'start':
      // 只有对应级别的用户才能开始任务
      return record.executor_id == currentUserId || 
             record.responsible_id == currentUserId || 
             record.approver_id == currentUserId
             
    case 'submit':
      // 只有执行人可以提交任务
      return record.executor_id == currentUserId
      
    case 'approve':
      // 只有审批人可以审核任务
      return record.approver_id == currentUserId
      
    case 'view':
      // 项目成员都可以查看
      return true
  }
}
```

## 3. 文件管理和上传逻辑

### 3.1 文件上传流程
```javascript
// 文件上传处理
const afterRead = (file) => {
  const fromData = new FormData()
  // 将base64转换为文件对象
  fromData.append('file', dataURLtoFileFun(file.content, file.file.name))
  
  saveFile(fromData).then((res) => {
    if(res.data.code == 1){
      file.status = 'done'
      Toast('上传成功')
      formState.img.push(res.data.id)  // 保存文件ID用于提交
    }else{
      file.status = 'failed'
      file.message = '上传失败'
    }
  })
}

// Base64转文件对象工具函数
export function dataURLtoFileFun (dataurl, filename) {
  const arr = dataurl.split(',')
  const mime = arr[0].match(/:(.*?);/)[1]
  const bstr = atob(arr[1])
  let n = bstr.length
  const u8arr = new Uint8Array(n)
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n)
  }
  return new File([u8arr], filename, { type: mime })
}
```

### 3.2 文件关联和权限
```javascript
// 文件与任务关联
const submitTask = (params) => {
  // 将上传的文件ID关联到任务
  if(formState.img.length > 0) {
    params.img = formState.img.join(",")
  }
  
  // 提交任务时包含文件信息
  submitProposaltask(params).then((res) => {
    // 任务提交成功，文件正式关联
  })
}

// 文件访问权限
// 只有项目成员才能访问项目相关文件
// 文件URL包含访问令牌进行权限验证
const fileUrl = `${process.env.VUE_APP_BASE_API}${filePath}?token=${getToken()}`
```

## 4. 数据模型关系逻辑

### 4.1 核心实体关系
```javascript
// 客户-项目关系 (1:N)
Customer {
  id: number,
  name: string,
  mobile: string,
  address: string,
  is_create_project: boolean  // 是否有关联项目
}

Project {
  id: number,
  customer_id: number,        // 外键关联客户
  project_name: string,
  start_time: date,
  end_time: date,
  status: string
}

// 项目-任务关系 (1:N)
Task {
  id: number,
  project_id: number,         // 外键关联项目
  task_name: string,
  level: number,              // 任务级别 1-3
  taskpid: number,           // 父任务ID (层级关系)
  executor_id: number,        // 执行人ID
  responsible_id: number,     // 负责人ID
  approver_id: number,        // 审批人ID
  state: number,              // 任务状态 0-3
  is_start: boolean,          // 是否已开始
  start_time: date,
  end_time: date
}

// 项目-成员关系 (N:M)
ProjectMember {
  project_id: number,
  user_id: number,
  role_id: number            // 角色ID决定权限
}
```

### 4.2 业务规则约束
```javascript
// 任务层级约束
const taskHierarchy = {
  level1: {
    name: "一级任务",
    parent: null,
    children: ["level2"]
  },
  level2: {
    name: "二级任务", 
    parent: "level1",
    children: ["level3"]
  },
  level3: {
    name: "三级任务",
    parent: "level2", 
    children: null
  }
}

// 任务状态约束
const stateTransition = {
  "0": ["1"],           // 进行中 -> 待审核
  "1": ["2", "0"],      // 待审核 -> 已完成 或 返回进行中
  "2": [],              // 已完成 (终态)
  "3": ["0"]            // 已延期 -> 进行中 (重新开始)
}

// 权限约束
const permissionRules = {
  executor: ["start", "submit"],           // 执行人：开始、提交
  responsible: ["view", "assign"],         // 负责人：查看、分配
  approver: ["view", "approve", "reject"]  // 审批人：查看、审批、拒绝
}
```

## 5. 业务流程时序

### 5.1 完整项目流程
```
1. 客户录入 -> 2. 项目创建 -> 3. 成员分配 -> 4. 任务规划
   ↓
5. 方案阶段 -> 6. 设计阶段 -> 7. 施工阶段 -> 8. 保障阶段
   ↓
9. 项目完成 -> 10. 归档总结
```

### 5.2 单个任务流程
```
任务创建 -> 任务分配 -> 任务开始 -> 任务执行 -> 成果提交 -> 任务审核 -> 任务完成
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  设置基本   分配执行   更新状态   上传文件   状态变更   审核意见   状态确认
   信息      人员      为进行中    和说明    为待审核    和结果    为已完成
```

## 6. 数据模型详细分析

### 6.1 客户数据模型
```javascript
// 客户实体结构
Customer {
  id: number,                    // 主键
  name: string,                  // 客户姓名
  gender: string,                // 性别
  age: number,                   // 年龄
  mobile: string,                // 手机号码
  province: string,              // 省份代码
  city: string,                  // 城市代码
  area: string,                  // 区域代码
  address: string,               // 详细地址
  updateDate: string,            // 更新时间
  familyMember: string,          // 家庭成员情况
  backdrop: string,              // 背景信息
  study: string,                 // 学习经历
  work: string,                  // 工作经历
  hobby: string,                 // 兴趣爱好
  is_create_project: boolean,    // 是否已创建项目
  description: string            // 备注描述
}

// 地址数据关联
const addressData = {
  provinces: require("@/config/province.json"),  // 省份数据
  cities: require("@/config/cities.json"),       // 城市数据
  areas: require("@/config/areas.json")          // 区域数据
}
```

### 6.2 项目数据模型
```javascript
// 项目实体结构
Project {
  id: number,                    // 项目ID
  project_name: string,          // 项目名称
  customer_id: number,           // 关联客户ID
  start_time: date,              // 开始时间
  end_time: date,                // 结束时间
  province: string,              // 项目所在省份
  city: string,                  // 项目所在城市
  area: string,                  // 项目所在区域
  address: string,               // 项目详细地址
  place: string,                 // 地址JSON数据
  description: string,           // 项目描述
  on_going_num: number,          // 进行中任务数量
  delay_num: number,             // 延期任务数量
  delayTasks: array,             // 延期任务列表
  status: string                 // 项目状态
}
```

### 6.3 任务数据模型
```javascript
// 任务实体结构
Task {
  id: number,                    // 任务ID
  task_id: number,               // 任务业务ID
  project_id: number,            // 关联项目ID
  task_name: string,             // 任务名称
  content: string,               // 任务内容
  level: number,                 // 任务级别 (1-3)
  taskpid: number,               // 父任务ID
  type: string,                  // 任务类型 (proposal/design/construction/ensure)

  // 人员分配
  executor_id: number,           // 执行人ID
  executor_name: string,         // 执行人姓名
  responsible_id: number,        // 负责人ID
  responsible_name: string,      // 负责人姓名
  approver_id: number,           // 审批人ID
  approver_name: string,         // 审批人姓名
  member_id: number,             // 成员ID

  // 状态管理
  state: number,                 // 任务状态 (0-3)
  is_start: boolean,             // 是否已开始
  is_checked: boolean,           // 是否已检查
  is_first: boolean,             // 是否首次任务
  place_order: boolean,          // 是否需要下单

  // 时间管理
  start_time: date,              // 开始时间
  end_time: date,                // 结束时间
  create_time: date,             // 创建时间

  // 附加信息
  remarks: string,               // 备注
  img_list: array,               // 附件列表
  father_task: object,           // 父任务信息
  loading: boolean               // 加载状态
}
```

### 6.4 用户角色模型
```javascript
// 用户实体
User {
  id: number,                    // 用户ID
  user_id: number,               // 业务用户ID
  nickname: string,              // 用户昵称
  name: string,                  // 真实姓名
  avatar: string,                // 头像URL
  mobile: string,                // 手机号
  access_token: string,          // 访问令牌
  roles: array                   // 用户角色列表
}

// 角色定义
Role {
  id: number,                    // 角色ID
  role_name: string,             // 角色名称
  permissions: array             // 权限列表
}

// 角色类型定义
const roleTypes = {
  1: "执行人员",                 // 具体执行任务的人员
  2: "Boss",                     // 高级管理人员
  3: "管理人员"                  // 中级管理人员
}
```

### 6.5 项目成员关系模型
```javascript
// 项目成员关联表
ProjectMember {
  id: number,                    // 关联ID
  project_id: number,            // 项目ID
  user_id: number,               // 用户ID
  role_id: number,               // 角色ID
  join_time: date,               // 加入时间
  status: string                 // 成员状态
}
```

### 6.6 文件管理模型
```javascript
// 文件实体
File {
  id: number,                    // 文件ID
  name: string,                  // 文件名
  path: string,                  // 文件路径
  size: number,                  // 文件大小
  type: string,                  // 文件类型
  upload_time: date,             // 上传时间
  uploader_id: number,           // 上传者ID
  task_id: number,               // 关联任务ID
  project_id: number             // 关联项目ID
}

// 文件上传状态
const fileStatus = {
  uploading: "上传中",
  done: "上传完成",
  failed: "上传失败"
}
```

### 6.7 沟通记录模型
```javascript
// 沟通记录实体
Communication {
  id: number,                    // 记录ID
  title: string,                 // 沟通标题
  date: date,                    // 沟通时间
  name: string,                  // 沟通人
  pic: string,                   // 相关图片
  desc: string,                  // 备注信息
  project_id: number,            // 关联项目ID
  stage: string                  // 所属阶段
}
```

## 7. 数据约束和业务规则

### 7.1 数据完整性约束
```javascript
// 必填字段验证
const requiredFields = {
  customer: ['name', 'mobile', 'address'],
  project: ['project_name', 'customer_id', 'start_time', 'end_time'],
  task: ['task_name', 'project_id', 'level', 'executor_id'],
  user: ['nickname', 'access_token']
}

// 数据格式验证
const dataValidation = {
  mobile: /^((13|14|15|17|18|19|16)[0-9]{1}\d{8})$/,  // 手机号格式
  date: /^\d{4}-\d{2}-\d{2}$/,                        // 日期格式
  email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/                 // 邮箱格式
}
```

### 7.2 业务逻辑约束
```javascript
// 任务层级约束
const taskLevelConstraints = {
  maxLevel: 3,                   // 最大任务层级
  parentChild: {                 // 父子关系约束
    1: [2],                      // 一级任务可以有二级子任务
    2: [3],                      // 二级任务可以有三级子任务
    3: []                        // 三级任务不能有子任务
  }
}

// 状态流转约束
const stateConstraints = {
  allowedTransitions: {
    0: [1, 3],                   // 进行中 -> 待审核/延期
    1: [0, 2],                   // 待审核 -> 进行中/已完成
    2: [],                       // 已完成 (终态)
    3: [0]                       // 延期 -> 进行中
  }
}

// 权限约束
const permissionConstraints = {
  taskOperation: {
    start: ['executor_id', 'responsible_id', 'approver_id'],
    submit: ['executor_id'],
    approve: ['approver_id'],
    view: ['project_member']
  }
}
```

### 7.3 数据关联规则
```javascript
// 外键关联规则
const foreignKeyRules = {
  'project.customer_id': 'customer.id',
  'task.project_id': 'project.id',
  'task.taskpid': 'task.id',
  'project_member.project_id': 'project.id',
  'project_member.user_id': 'user.id',
  'file.task_id': 'task.id',
  'file.project_id': 'project.id'
}

// 级联操作规则
const cascadeRules = {
  deleteProject: {
    cascade: ['task', 'project_member', 'file'],  // 删除项目时级联删除
    restrict: ['customer']                        // 有客户关联时限制删除
  },
  deleteCustomer: {
    restrict: ['project']                         // 有项目关联时限制删除
  }
}
```

## 8. 文件管理和上传详细逻辑

### 8.1 文件上传流程
```javascript
// 文件上传处理函数
const afterRead = (file) => {
  // 1. 创建FormData对象
  const fromData = new FormData()

  // 2. 将base64转换为File对象
  const fileObj = dataURLtoFileFun(file.content, file.file.name)
  fromData.append('file', fileObj)

  // 3. 调用上传API
  saveFile(fromData).then((res) => {
    if(res.data.code == 1){
      file.status = 'done'
      Toast('上传成功')
      // 4. 保存文件ID到表单状态
      formState.img.push(res.data.id)
    }else{
      file.status = 'failed'
      file.message = '上传失败'
    }
  }).catch((err) => {
    file.status = 'failed'
    file.message = '上传失败'
  })
}

// Base64转File对象工具函数
export function dataURLtoFileFun(dataurl, filename) {
  const arr = dataurl.split(',')
  const mime = arr[0].match(/:(.*?);/)[1]
  const bstr = atob(arr[1])
  let n = bstr.length
  const u8arr = new Uint8Array(n)
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n)
  }
  return new File([u8arr], filename, { type: mime })
}
```

### 8.2 文件关联逻辑
```javascript
// 任务提交时关联文件
const onSubmit = () => {
  let params = {
    project_id: state.data.project_id,
    remarks: formState.remarks || "",
    member_id: formState.memberId
  }

  // 关联上传的文件
  if(formState.img.length > 0) {
    params.img = formState.img.join(",")  // 文件ID数组转字符串
  }

  // 验证必须上传附件
  if(fileList.value.length == 0) {
    Toast("必须上传附件!")
    return false
  }

  // 提交任务和文件关联
  let post = dynamicinterface[state.data.type.toString()][1]
  post(params).then((res) => {
    if (res.data.code == 1) {
      Toast("提交成功!")
      // 文件正式关联到任务
    }
  })
}
```

### 8.3 文件显示和预览
```javascript
// 文件列表显示
const initFileList = (imgList) => {
  if(imgList.length > 0){
    let fileArray = []
    for(let j in imgList){
      fileArray.push({
        uid: j,
        name: j,
        status: 'done',
        url: process.env.VUE_APP_BASE_API + imgList[j].path  // 完整文件URL
      })
    }
    fileList.value = [...fileArray]
  }
}

// 文件预览处理
const handlePreview = async (file) => {
  if (!file.url && !file.preview) {
    file.preview = (await getBase64(file.originFileObj))
  }
  state.path = file.url || file.preview
  previewVisible.value = true
}

// Base64预览函数
function getBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.readAsDataURL(file)
    reader.onload = () => resolve(reader.result)
    reader.onerror = error => reject(error)
  })
}
```

### 8.4 文件权限控制
```javascript
// 文件访问权限验证
const fileAccessControl = {
  // 只有项目成员可以访问项目文件
  checkProjectAccess: (userId, projectId) => {
    return projectMembers.includes(userId)
  },

  // 只有任务相关人员可以访问任务文件
  checkTaskAccess: (userId, taskId) => {
    const task = getTaskById(taskId)
    return [task.executor_id, task.responsible_id, task.approver_id].includes(userId)
  },

  // 文件URL包含访问令牌
  generateFileUrl: (filePath, token) => {
    return `${process.env.VUE_APP_BASE_API}${filePath}?token=${token}`
  }
}
```

## 9. 延期任务处理逻辑

### 9.1 延期任务识别机制
```javascript
// 延期任务查询参数
const getDelayTaskParams = () => {
  let params = `?project_id=${projectId}&page=${page}&limit=${limit}`

  if(state.curMenuTag == '1'){  // 延期任务标签
    params += `&is_delay=1`     // 添加延期标识
  }
  return params
}

// 后端延期任务识别逻辑 (推测)
const identifyDelayTasks = () => {
  // SQL查询延期任务
  const sql = `
    SELECT * FROM tasks
    WHERE end_time < NOW()
    AND state IN (0, 1)  -- 进行中或待审核状态
    AND project_id = ?
  `

  // 更新延期标识
  const updateSql = `
    UPDATE tasks
    SET state = 3, is_delay = 1
    WHERE end_time < NOW()
    AND state IN (0, 1)
  `
}
```

### 9.2 延期任务统计显示
```javascript
// 项目信息中的延期统计
const getProjectInfo = () => {
  getProjectInfo(`?project_id=${projectId}`).then((res) => {
    if(res.data.code == 1){
      let item = res.data.data
      state.projectInfo = item
      state.goingNum = item.on_going_num    // 进行中任务数量
      state.delayNum = item.delay_num       // 延期任务数量

      // 延期任务详细列表
      state.delayTasks = item.delayTasks || []
    }
  })
}

// 延期任务标签显示
<van-tab :title="`已延期任务(${delayNum})`" name="1"></van-tab>

// 延期任务提示显示
<div class="delay-task" v-if="item.delayTasks.length > 0">
  <img :src="require('@/assets/svg/delayTasks.svg')">
  <p>当前项目延期任务共{{ item.delayTasks.length }}条</p>
</div>
```

### 9.3 延期任务处理流程
```javascript
// 延期任务重新开始
const restartDelayTask = (taskId) => {
  const params = {
    task_id: taskId,
    action: 'restart'
  }

  startTask(params).then((res) => {
    if(res.data.code == 1){
      // 更新任务状态从延期(3)到进行中(0)
      updateTaskState(taskId, 0)
      Toast('任务重新开始成功')
    }
  })
}

// 延期任务时间调整
const adjustDelayTaskTime = (taskId, newEndTime) => {
  const params = {
    task_id: taskId,
    end_time: newEndTime,
    action: 'adjust_time'
  }

  updateTaskTime(params).then((res) => {
    if(res.data.code == 1){
      Toast('任务时间调整成功')
      // 如果新时间未过期，状态改为进行中
      if(new Date(newEndTime) > new Date()){
        updateTaskState(taskId, 0)
      }
    }
  })
}
```

### 9.4 延期任务通知机制
```javascript
// 延期任务通知逻辑 (推测实现)
const delayTaskNotification = {
  // 检查即将延期的任务
  checkUpcomingDelay: () => {
    const sql = `
      SELECT * FROM tasks
      WHERE end_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 1 DAY)
      AND state IN (0, 1)
    `
    // 发送提醒通知
  },

  // 延期任务通知
  notifyDelayTasks: (tasks) => {
    tasks.forEach(task => {
      // 通知执行人
      sendNotification(task.executor_id, `任务"${task.task_name}"已延期`)

      // 通知负责人
      sendNotification(task.responsible_id, `任务"${task.task_name}"已延期`)

      // 通知审批人
      sendNotification(task.approver_id, `任务"${task.task_name}"已延期`)
    })
  }
}
```

## 10. Excel数据处理逻辑

### 10.1 Excel导入处理
```javascript
// Excel数据解析函数
export async function loadExlcel(exlcelData, tableData) {
  // 列映射定义
  let col = {
    B: 'firstTaskName',      // 一级任务名称
    C: 'firstTaskDateStr',   // 一级任务时间
    E: 'secondTaskName',     // 二级任务名称
    F: 'secondTaskDateStr',  // 二级任务时间
    H: 'thirdTaskName',      // 三级任务名称
    I: 'thirdTaskDateStr',   // 三级任务时间
    J: 'executor',           // 执行人
    K: 'chargePerson',       // 负责人
    L: 'approver',           // 审批人
    M: 'content',            // 内容
  }

  // 数据结构定义
  let firstTask = { rows: [], data: [], relationData: [] }
  let secondaryTask = { rows: [], data: [], relationData: [] }
  let threeTask = { rows: [], data: [] }

  // 解析Excel数据
  let tempData = {}
  for (let i in col) {
    for (let j in exlcelData) {
      let temp = {}
      let key = Number(j.substr(1))
      if (!isNaN(key) && key > 2 && j.indexOf(i) != -1) {
        let data = exlcelData[j]
        temp[key] = data.v
      }
      if (JSON.stringify(temp) != '{}') {
        tempData[i] = { ...tempData[i], ...temp }
      }
    }
  }

  return {code: 1, data: [...firstTask.data, ...secondaryTask.data, ...threeTask.data]}
}
```

### 10.2 时间格式验证
```javascript
// Excel时间格式验证
const validateTimeFormat = (timeStr, taskName) => {
  if(!timeStr) {
    return {
      is_data: false,
      msg: `${taskName} 没有设置时间!`
    }
  }

  const timeArray = timeStr.split('~')
  if(timeArray.length !== 2) {
    return {
      is_data: false,
      msg: `${taskName} 时间格式不正确!`
    }
  }

  const startTime = new Date(timeArray[0])
  const endTime = new Date(timeArray[1])

  if(isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
    return {
      is_data: false,
      msg: `${taskName} ${timeStr} 时间格式不正确!`
    }
  }

  return { is_data: true }
}
```

这个详细的业务逻辑实现分析揭示了Special项目的核心业务机制，包括复杂的状态流转、权限控制、文件管理、数据模型关系、业务规则约束、延期任务处理和Excel数据处理等完整的业务逻辑体系。
