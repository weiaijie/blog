# Special 项目业务流程图和状态图

## 1. 任务状态流转图

### 1.1 任务状态流转状态图
```mermaid
stateDiagram-v2
    [*] --> 未开始
    未开始 --> 进行中 : 开始任务
    进行中 --> 待审核 : 提交任务
    进行中 --> 已延期 : 超过截止时间
    待审核 --> 已完成 : 审核通过
    待审核 --> 进行中 : 审核拒绝/返工
    已延期 --> 进行中 : 重新开始
    已完成 --> [*]
    
    note right of 进行中
        状态码: 0
        可操作: 提交任务
    end note
    
    note right of 待审核
        状态码: 1
        可操作: 审核通过/拒绝
    end note
    
    note right of 已完成
        状态码: 2
        终态
    end note
    
    note right of 已延期
        状态码: 3
        可操作: 重新开始
    end note
```

### 1.2 用户角色权限状态图
```mermaid
stateDiagram-v2
    [*] --> 游客
    游客 --> 已登录 : 飞书登录
    已登录 --> 执行人员 : 角色分配
    已登录 --> 负责人员 : 角色分配
    已登录 --> 审批人员 : 角色分配
    
    执行人员 --> 任务执行 : 开始任务
    负责人员 --> 任务管理 : 分配任务
    审批人员 --> 任务审核 : 审核任务
    
    任务执行 --> 已登录 : 任务完成
    任务管理 --> 已登录 : 管理完成
    任务审核 --> 已登录 : 审核完成
    
    已登录 --> 游客 : 登出/Token过期
```

## 2. 业务流程图

### 2.1 完整项目生命周期流程
```mermaid
flowchart TD
    A[客户录入] --> B[项目创建]
    B --> C[项目成员分配]
    C --> D[项目计划制定]
    D --> E[方案阶段]
    E --> F[设计阶段]
    F --> G[施工阶段]
    G --> H[保障阶段]
    H --> I[项目完成]
    
    E --> E1[方案任务创建]
    E1 --> E2[方案任务执行]
    E2 --> E3[方案任务提交]
    E3 --> E4[方案任务审核]
    E4 --> E5{审核结果}
    E5 -->|通过| F
    E5 -->|拒绝| E2
    
    F --> F1[设计任务创建]
    F1 --> F2[设计任务执行]
    F2 --> F3[设计任务提交]
    F3 --> F4[设计任务审核]
    F4 --> F5{审核结果}
    F5 -->|通过| G
    F5 -->|拒绝| F2
    
    G --> G1[施工任务创建]
    G1 --> G2[施工任务执行]
    G2 --> G3[施工任务提交]
    G3 --> G4[施工任务审核]
    G4 --> G5{审核结果}
    G5 -->|通过| H
    G5 -->|拒绝| G2
    
    H --> H1[保障任务创建]
    H1 --> H2[保障任务执行]
    H2 --> H3[保障任务提交]
    H3 --> H4[保障任务审核]
    H4 --> H5{审核结果}
    H5 -->|通过| I
    H5 -->|拒绝| H2
```

### 2.2 任务执行详细流程
```mermaid
flowchart TD
    A[任务分配] --> B{是否今天开始}
    B -->|是| C[显示开始按钮]
    B -->|否| D[等待开始时间]
    
    C --> E[点击开始任务]
    E --> F[更新任务状态为进行中]
    F --> G[任务执行]
    
    G --> H[上传附件]
    H --> I[填写说明]
    I --> J{验证提交条件}
    
    J -->|附件缺失| K[提示上传附件]
    J -->|子任务未完成| L[提示完成子任务]
    J -->|验证通过| M[提交任务]
    
    K --> H
    L --> G
    
    M --> N[更新状态为待审核]
    N --> O[通知审核人员]
    O --> P{审核结果}
    
    P -->|通过| Q[任务完成]
    P -->|拒绝| R[返回修改]
    R --> G
    
    D --> S{检查延期}
    S -->|超时| T[标记为延期]
    S -->|未超时| D
    
    T --> U[延期任务处理]
    U --> V{处理方式}
    V -->|重新开始| F
    V -->|调整时间| W[更新截止时间]
    W --> F
```

### 2.3 文件上传处理流程
```mermaid
flowchart TD
    A[选择文件] --> B[文件读取为Base64]
    B --> C[Base64转File对象]
    C --> D[创建FormData]
    D --> E[调用上传API]
    E --> F{上传结果}
    
    F -->|成功| G[保存文件ID]
    F -->|失败| H[显示错误信息]
    
    G --> I[更新文件状态为完成]
    I --> J[添加到文件列表]
    J --> K[任务提交时关联文件]
    
    H --> L[重新上传]
    L --> A
    
    K --> M[验证文件权限]
    M --> N{权限检查}
    N -->|有权限| O[文件关联成功]
    N -->|无权限| P[权限错误]
```

## 3. 用户交互时序图

### 3.1 用户登录时序图
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端应用
    participant N as Node中间层
    participant P as PHP后端
    participant FS as 飞书服务
    
    U->>F: 访问应用
    F->>F: 检查Token
    alt Token不存在或过期
        F->>FS: 重定向到飞书登录
        FS->>U: 显示登录页面
        U->>FS: 输入凭据
        FS->>F: 返回授权码
        F->>N: 发送登录请求(code)
        N->>P: 转发登录请求
        P->>FS: 验证授权码
        FS->>P: 返回用户信息
        P->>N: 返回Token和用户信息
        N->>F: 返回登录结果
        F->>F: 保存Token和用户信息
    end
    F->>U: 显示应用主界面
```

### 3.2 任务操作时序图
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端应用
    participant N as Node中间层
    participant P as PHP后端
    participant DB as 数据库
    
    U->>F: 点击开始任务
    F->>F: 验证用户权限
    F->>N: 发送开始任务请求
    N->>P: 转发请求
    P->>DB: 更新任务状态
    DB->>P: 返回更新结果
    P->>N: 返回操作结果
    N->>F: 返回结果
    F->>F: 更新界面状态
    F->>U: 显示操作成功
    
    U->>F: 上传文件
    F->>N: 发送文件上传请求
    N->>P: 转发文件
    P->>P: 保存文件到服务器
    P->>DB: 保存文件信息
    DB->>P: 返回文件ID
    P->>N: 返回文件ID
    N->>F: 返回上传结果
    F->>F: 更新文件列表
    
    U->>F: 提交任务
    F->>F: 验证提交条件
    F->>N: 发送提交请求(包含文件ID)
    N->>P: 转发请求
    P->>DB: 更新任务状态和关联文件
    DB->>P: 返回更新结果
    P->>N: 返回提交结果
    N->>F: 返回结果
    F->>U: 显示提交成功
```

## 4. 数据流向图

### 4.1 系统数据流向
```mermaid
flowchart LR
    A[移动端用户] --> B[Vue前端应用]
    C[管理端用户] --> D[Vue管理后台]
    
    B --> E[Node.js中间层]
    D --> E
    
    E --> F[PHP后端服务]
    F --> G[MySQL数据库]
    F --> H[Redis缓存]
    
    I[文件存储] --> F
    J[飞书API] --> F
    
    subgraph "前端层"
        B
        D
    end
    
    subgraph "中间层"
        E
    end
    
    subgraph "后端层"
        F
        G
        H
        I
        J
    end
```

### 4.2 任务数据流转
```mermaid
flowchart TD
    A[任务创建] --> B[任务分配]
    B --> C[任务执行]
    C --> D[文件上传]
    D --> E[任务提交]
    E --> F[任务审核]
    F --> G[任务完成]
    
    subgraph "数据变更"
        H[状态: 未开始 → 进行中]
        I[状态: 进行中 → 待审核]
        J[状态: 待审核 → 已完成]
        K[关联: 任务 ← 文件]
        L[通知: 相关人员]
    end
    
    B --> H
    E --> I
    E --> K
    F --> J
    F --> L
```

这些流程图和状态图清晰地展示了Special项目的核心业务逻辑，包括任务状态流转、用户交互流程、数据流向等关键业务机制。
