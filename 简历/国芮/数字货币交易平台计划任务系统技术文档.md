# 数字货币交易平台计划任务系统技术文档

## 📋 文档概述

**项目名称**: 数字货币交易平台后台管理系统  
**文档版本**: v1.0  
**创建日期**: 2025-01-12  
**技术栈**: Node.js + Express + MySQL + Redis + Vue.js  

## 🏗️ 系统架构概览

### 核心组件
- **commonSchedule.js**: 基于node-schedule的定时任务调度器
- **interval.js**: 基于setInterval的间隔任务执行器  
- **notice.js**: 监控预警通知系统
- **metrics.js**: Prometheus性能监控系统
- **logger.js**: 双引擎日志系统

## ⏰ 定时任务调度系统

### 1. 调度器架构 (commonSchedule.js)

#### 1.1 技术实现
```javascript
// 使用node-schedule库实现cron风格的任务调度
var schedule = require('node-schedule');

// 支持两种调度规则：
// 1. RecurrenceRule对象 - 精确时间控制
// 2. Cron表达式 - 标准cron语法
```

#### 1.2 环境控制机制
```javascript
// 多环境任务控制
let init = function(){
    if( config.env89 || config.proBeta || config.isProxy ) return 
    initdata()
    watchAudit()
    watchLGAudit()
    if( config.closeTask ) return 
    // 其他任务...
}
```

### 2. 核心定时任务清单

#### 2.1 监控类任务

| 任务名称 | 执行频率 | 功能描述 | 实现方法 |
|---------|---------|---------|---------|
| **资产监控** | 每小时0分、30分 | 监控关键账户USDT余额 | `watchAssetJob()` |
| **提现审核监控** | 每分钟1秒、40秒 | 检查待审核提现数量 | `watchAudit()` |
| **法币审核监控** | 每分钟5秒、45秒 | 检查法币交易审核积压 | `watchLGAudit()` |
| **借贷质押率监控** | 每10分钟 | 监控借贷订单质押率风险 | `watchloanrate()` |
| **借贷到期监控** | 每天23:01:30 | 检查借贷订单到期情况 | `watchloan3()` |

#### 2.2 业务处理任务

| 任务名称 | 执行时间 | 功能描述 | 实现方法 |
|---------|---------|---------|---------|
| **余币宝收益发放** | 每天16:08:01 | 发放活期余币宝收益 | `updateybb.init345(5)` |
| **余币宝订单确认** | 每天16:18:01 | 确认活期余币宝订单 | `updateybb.init345(3)` |
| **余币宝利率检查** | 每天16:28:01 | 检查当日利率设置 | `updateybb.checkTodayRate()` |
| **定期余币宝结算** | 每天16:38:01 | 结算到期定期产品 | `updateybb.init102()` |
| **定期余币宝确认** | 每天16:48:01 | 确认定期产品订单 | `updateybb.init101()` |
| **跟单日报生成** | 每天17:01:01 | 生成跟单交易日报 | `folDailyReport.init()` |
| **配置参数同步** | 每天17:01:30 | 同步系统配置参数 | `CONF.init()` |

#### 2.3 通信类任务

| 任务名称 | 执行频率 | 功能描述 | 实现方法 |
|---------|---------|---------|---------|
| **邮件批量发送** | 每5分钟 | 批量发送系统邮件 | `intervalSendEmail.init()` |
| **资金流水记录** | 每秒 | 记录资金变动流水 | `writeAdm_moneyRcd.init()` |

## 🔔 监控预警系统 (notice.js)

### 1. 短信通知系统

#### 1.1 通知机制
```javascript
// 支持多号码批量发送
let phones = [ '18019319817']
let SmsData = {
    PhoneNumbers: '0086-'+ phones[index],
    text: '【Gmex】' + smsMsg
}
```

#### 1.2 监控项目

**资产监控**:
- 监控账户: ['20521', '20526', '20026', '20226']
- 预警阈值: USDT余额 < 2000
- 通知内容: "警告：{渠道}-{用户ID}，可用资金低于2000!"

**借贷风险监控**:
- 补仓预警: 当前质押率 ≥ 补仓质押率
- 平仓预警: 当前质押率 ≥ 平仓质押率
- 到期提醒: 借贷订单到期前3天通知

### 2. 邮件通知系统

#### 2.1 邮件类型
- 系统错误通知
- 业务异常报告
- 定期运营报表
- 审核提醒通知

#### 2.2 发送策略
- 批量发送: 避免频繁请求
- 失败重试: 自动重试机制
- 内容模板: 标准化邮件格式

## 📊 性能监控系统 (metrics.js)

### 1. Prometheus集成

#### 1.1 监控指标

**接口监控**:
```javascript
// 接口调用次数统计
const g = new Gauge({
    name: preName + 'count',
    help: '后台接口监控',
    labelNames: ['routename'],
});

// 接口耗时监控
const gtime = new Gauge({
    name: preName + 'time', 
    help: '后台接口耗时监控',
    labelNames: ['label'],
});
```

**系统监控**:
```javascript
// Node.js内存监控
const gnode = new Gauge({
    name: preName + 'node_info',
    help: 'node内存监控', 
    labelNames: ['nodetype'],
});
```

#### 1.2 监控数据

**内存指标**:
- 物理总内存(RSS)
- 总申请内存(heapTotal)
- 已使用内存(heapUsed)
- C++对象内存(external)

**接口指标**:
- 调用次数统计
- 最小/最大/平均耗时
- 错误率统计

### 2. 路由监控系统 (watchRoute.js)

#### 2.1 监控机制
```javascript
// URL访问统计
wroute.setURLcount = function({url, st}){
    let key = url
    if ( !wroute.countdata.hasOwnProperty(key) ){
        wroute.countdata[key] = {
            routename: url, 
            count: 0, 
            eachtime: {} 
        }
    }
    wroute.countdata[key].count++
}
```

#### 2.2 性能分析
- 请求计数统计
- 响应时间分析
- 热点接口识别
- 性能瓶颈定位

## 📝 日志系统架构

### 1. 双引擎设计

#### 1.1 Pino日志引擎 (主要)
```javascript
// 高性能JSON格式日志
const pino = require('pino');
const logger = pino(pinoOptions)
global.logger = logger
```

**特点**:
- 高性能异步写入
- JSON结构化输出
- 内存占用低
- 支持流式处理

#### 1.2 Log4js日志引擎 (备用)
```javascript
// 传统日志格式，支持邮件通知
log4js.configure({
    appenders: {
        error: {
            type: 'dateFile',
            filename: 'logs/error-',
            pattern: 'yyyy-MM-dd.log'
        },
        email: {
            type: '@log4js-node/smtp',
            sender: '568636504@qq.com',
            subject: 'Node 错误日志'
        }
    }
});
```

### 2. 日志分类体系

| 日志类型 | 文件名格式 | 用途描述 |
|---------|-----------|---------|
| **应用日志** | `app-yyyy-MM-dd.log` | 业务操作记录 |
| **错误日志** | `error-yyyy-MM-dd.log` | 系统异常信息 |
| **警告日志** | `warn-yyyy-MM-dd.log` | 系统警告信息 |
| **服务日志** | `server-yyyy-MM-dd.log` | 服务运行日志 |

### 3. 错误处理机制

#### 3.1 全局异常捕获
```javascript
process.on('uncaughtException', function (err) {
    logger.info('全局异常错误: ', err)
    logger.error('全局异常错误: ' + err.stack)
});
```

#### 3.2 错误聚合机制
- 相同错误去重
- 批量错误报告
- 自动邮件通知
- 错误统计分析

## 🔧 系统配置管理

### 1. 环境配置

#### 1.1 多环境支持
```javascript
let env = process.env.NODE_ENV.trim();
const config = {
    env89: true,        // 测试环境
    proBeta: true,      // 预发布环境  
    isProxy: false,     // 代理环境
    closeTask: true,    // 任务开关
}
```

#### 1.2 任务控制策略
- **测试环境**: 关闭所有定时任务
- **预发布环境**: 仅开启监控任务
- **生产环境**: 全量任务运行
- **代理环境**: 特定任务集合

### 2. 动态配置同步

#### 2.1 配置同步机制
```javascript
// 每天定时同步配置
let asynceConf = function(){
    let rule = '30 1 17 * * *'
    schedule.scheduleJob(rule, function(){ 
        CONF.init()
    });
}
```

#### 2.2 配置管理功能
- 实时配置更新
- 配置版本控制
- 配置回滚机制
- 配置审计日志

## 🚀 部署与运维

### 1. 服务启动流程

#### 1.1 初始化顺序
1. 加载环境配置
2. 初始化数据库连接
3. 启动定时任务调度器
4. 开启监控系统
5. 启动Web服务

#### 1.2 健康检查
- 数据库连接状态
- Redis连接状态  
- 定时任务运行状态
- 内存使用情况

### 2. 监控告警

#### 2.1 告警规则
- 内存使用率 > 80%
- 接口响应时间 > 5秒
- 错误率 > 1%
- 关键账户余额不足

#### 2.2 告警渠道
- 短信通知
- 邮件报告
- 系统日志
- 监控面板

## 📈 性能优化建议

### 1. 任务调度优化
- 避免任务时间冲突
- 合理分配系统资源
- 实现任务优先级机制
- 添加任务执行超时控制

### 2. 监控系统优化
- 增加业务指标监控
- 实现分布式监控
- 优化数据存储策略
- 提升告警准确性

### 3. 日志系统优化
- 实现日志轮转机制
- 添加日志压缩功能
- 优化日志查询性能
- 实现日志分析工具

## 🔒 安全考虑

### 1. 任务安全
- 任务执行权限控制
- 敏感操作审计
- 任务执行结果验证
- 异常任务自动停止

### 2. 监控安全
- 监控数据加密传输
- 访问权限控制
- 敏感信息脱敏
- 监控接口安全认证

## 📋 任务执行时间表

### 每日任务时间轴 (UTC+8)

```
16:01:01 - 资产数据更新 (已注释)
16:08:01 - 余币宝收益发放 (updateybb.init345(5))
16:18:01 - 余币宝订单确认 (updateybb.init345(3))
16:28:01 - 余币宝利率检查 (updateybb.checkTodayRate())
16:38:01 - 定期余币宝结算 (updateybb.init102())
16:48:01 - 定期余币宝确认 (updateybb.init101())
17:01:01 - 跟单日报生成 (folDailyReport.init())
17:01:30 - 配置参数同步 (CONF.init())
23:01:30 - 借贷到期检查 (NOTICE.loandate3())
```

### 高频监控任务

```
每秒执行:
- 资金流水记录 (writeAdm_moneyRcd.init())

每分钟执行:
- 01秒,40秒: 提现审核监控 (NOTICE.getAuditRcdLV1())
- 05秒,45秒: 法币审核监控 (NOTICE.getLGAuditRcdCountLV1())

每10分钟执行:
- 00分,10分,20分,30分,40分,50分: 借贷质押率监控 (NOTICE.loanrate())

每30分钟执行:
- 00分,30分: 资产余额监控 (NOTICE.watchAsset())

每5分钟执行:
- 邮件批量发送 (intervalSendEmail.init())
```

## 🔄 余币宝业务流程详解

### 1. 活期余币宝处理流程

#### 1.1 收益发放 (16:08:01)
```javascript
// 操作类型: 5 - 发放收益
updateybb.init345(5)

流程:
1. 获取所有活期产品配置 (ALL_YBB_GOODS)
2. 遍历每个产品ID
3. 调用 updateYBB.exeYbb345({pid, opType: 5})
4. 通过gRPC调用核心系统 YbbAdm 接口
5. 记录执行结果到 adm_ybb 表
```

#### 1.2 订单确认 (16:18:01)
```javascript
// 操作类型: 3 - 确认订单
updateybb.init345(3)

流程:
1. 检查收益是否已发放 (status=1)
2. 确认当日收益发放成功
3. 执行订单确认操作
4. 更新订单状态
```

#### 1.3 利率检查 (16:28:01)
```javascript
updateybb.checkTodayRate()

流程:
1. 检查当日是否设置利率
2. 如未设置，使用前一日利率
3. 如前一日无利率，使用默认利率
4. 自动设置当日利率配置
```

### 2. 定期余币宝处理流程

#### 2.1 定期结算 (16:38:01)
```javascript
updateybb.init102()

流程:
1. 查询到期定期订单 (status=2, EndTime < now)
2. 按100个订单分批处理
3. 调用 setTermOrder({opType: 102, orders})
4. 每批次间隔5秒执行
5. 结算本金和收益到用户账户
```

#### 2.2 定期确认 (16:48:01)
```javascript
updateybb.init101()

流程:
1. 查询待确认定期订单 (status=1)
2. 按100个订单分批处理
3. 调用 setTermOrder({opType: 101, orders})
4. 确认订单生效
5. 开始计息
```

## 🚨 监控预警详细机制

### 1. 资产监控系统

#### 1.1 监控对象
```javascript
let watchUid = ['20521', '20526', '20026', '20226']  // 关键账户
let minMainBal = 2000  // USDT最低余额阈值
```

#### 1.2 预警流程
```
1. 查询关键账户USDT余额
2. 筛选余额 < 2000 的账户
3. 生成预警消息
4. 发送短信通知: "警告：{渠道}-{用户ID}，可用资金低于2000!"
```

### 2. 借贷风险监控

#### 2.1 质押率计算
```javascript
// 每10分钟检查一次
notice.loanrate()

计算逻辑:
1. 获取实时行情数据 (ticks)
2. 获取借贷配置 (loancfg)
3. 查询活跃借贷订单 (status=2)
4. 计算当前质押率 = 抵押品价值 / 借贷金额
5. 对比补仓线和平仓线
```

#### 2.2 风险等级
- **补仓预警**: 当前质押率 ≥ 补仓质押率
- **平仓预警**: 当前质押率 ≥ 平仓质押率
- **到期提醒**: 距离到期时间 ≤ 3天

#### 2.3 处理动作
```javascript
// 补仓通知
if(alarmresult.alarmcall==110) {
    // 发送补仓短信
    loan.sendcall(userinfo, alarmcall.data)
}

// 平仓通知
if(alarmresult.alarmliqu==110) {
    // 发送平仓短信
    loan.sendliqu(userinfo, alarmliqu.data)
}

// 自动平仓
if(itemtype==5) {
    // 执行强制平仓
    loan.setcloseloanorder(closedata)
}
```

### 3. 审核监控系统

#### 3.1 提现审核监控
```javascript
// 每分钟1秒、40秒执行
NOTICE.getAuditRcdLV1()

监控内容:
- 待审核提现订单数量
- 审核积压时间
- 大额提现预警
- 异常提现检测
```

#### 3.2 法币审核监控
```javascript
// 每分钟5秒、45秒执行
NOTICE.getLGAuditRcdCountLV1()

监控内容:
- 法币交易审核队列
- 审核处理效率
- 异常交易标记
- 风控规则触发
```

## 📊 性能监控指标体系

### 1. 系统性能指标

#### 1.1 内存监控
```javascript
let memoryUsage = process.memoryUsage()
let rss = parseInt(Number(memoryUsage.rss)/(1024*1024))           // 物理内存
let heaptotal = parseInt(Number(memoryUsage.heapTotal)/(1024*1024)) // 总申请内存
let heapused = parseInt(Number(memoryUsage.heapUsed)/(1024*1024))   // 已使用内存
let external = parseInt(Number(memoryUsage.external)/(1024*1024))   // C++对象内存
```

#### 1.2 接口性能监控
```javascript
// 接口调用统计
g.set({ routename: item.routename}, item.count);

// 接口耗时分析
gtime.set({ label: item.routename + '最小耗时(ms)： '}, min_tm);
gtime.set({ label: item.routename + '最大耗时(ms)： '}, max_tm);
gtime.set({ label: item.routename + '平均耗时(ms)： '}, avg_tm);
```

### 2. 业务性能指标

#### 2.1 交易性能
- 订单处理速度
- 撮合引擎延迟
- 资金结算时间
- 提现处理效率

#### 2.2 用户体验指标
- 页面加载时间
- API响应时间
- 错误率统计
- 并发用户数

## 🔧 运维管理指南

### 1. 任务管理命令

#### 1.1 手动执行任务
```bash
# 手动发放余币宝收益
curl -X POST http://localhost:3000/api/adm/ybb/setYbb5 -d "pid=00001"

# 手动确认余币宝订单
curl -X POST http://localhost:3000/api/adm/ybb/setYbb3 -d "pid=00001"

# 手动检查利率设置
curl -X POST http://localhost:3000/api/adm/ybb/checkRate -d "pid=00001"
```

#### 1.2 任务状态查询
```bash
# 查看任务执行历史
curl -X GET http://localhost:3000/api/adm/ybb/getAdmYbb?pid=00001&type=5

# 查看系统监控指标
curl -X GET http://localhost:3000/api/adm/metrics
```

### 2. 故障排查指南

#### 2.1 常见问题
1. **任务执行失败**
   - 检查数据库连接
   - 验证gRPC服务状态
   - 查看错误日志

2. **监控告警异常**
   - 确认短信服务配置
   - 检查邮件服务状态
   - 验证告警规则设置

3. **性能指标异常**
   - 检查内存使用情况
   - 分析接口响应时间
   - 查看数据库性能

#### 2.2 日志查看
```bash
# 查看应用日志
tail -f logs/app-$(date +%Y-%m-%d).log

# 查看错误日志
tail -f logs/error-$(date +%Y-%m-%d).log

# 查看服务日志
tail -f logs/server-$(date +%Y-%m-%d).log
```

### 3. 配置管理

#### 3.1 环境配置
```javascript
// config/config.js
module.exports = {
    env89: false,        // 生产环境设为false
    proBeta: false,      // 生产环境设为false
    isProxy: false,      // 是否为代理环境
    closeTask: false,    // 生产环境设为false启用任务

    // 数据库配置
    mysql: {
        host: '192.168.2.141',
        user: 'root',
        password: 'root',
        database: 'gaea'
    },

    // Redis配置
    redis: {
        host: '192.168.2.91',
        port: 6379,
        db: 9
    }
}
```

#### 3.2 任务开关控制
```javascript
// 全局任务开关
if( config.closeTask ) return

// 特定环境任务控制
if( config.env89 || config.proBeta || config.isProxy ) return
```

---

**文档维护**: 请定期更新此文档以反映系统变更
**联系方式**: 如有疑问请联系系统管理员
**最后更新**: 2025-01-12
